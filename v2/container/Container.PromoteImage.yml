parameters:
- name: sourceUseAzureServiceConnection
  type: boolean
  default: false
- name: sourceContainerRegistryServiceConnection
  type: string
- name: sourceContainerRegistryName
  type: string
- name: dockerRepositoryName
  type: string
- name: imageTag
  type: string
- name: destinationUseAzureServiceConnection
  type: boolean
  default: false
- name: destinationContainerRegistryServiceConnection
  type: string
- name: destinationContainerRegistryName
  type: string


steps:
- ${{ if eq(parameters.sourceUseAzureServiceConnection, true) }}:
  - task: AzureCLI@2
    displayName: 'Login to source registry using Azure Service Connection'
    inputs:
      azureSubscription: ${{ parameters.sourceContainerRegistryServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: 'az acr login --name ${{ parameters.sourceContainerRegistryName }}'

- ${{ if eq(parameters.sourceUseAzureServiceConnection, false) }}:
  - task: Docker@2
    displayName: 'Login to source registry using Docker Service Connection'
    inputs:
      command: 'login'
      containerRegistry: ${{ parameters.sourceContainerRegistryServiceConnection }}

- task: CmdLine@2
  displayName: 'Docker pull from source ACR'
  inputs:
    script: 
      docker pull ${{ parameters.sourceContainerRegistryName }}.azurecr.io/${{ parameters.dockerRepositoryName }}:${{ parameters.imageTag }};
      docker tag ${{ parameters.sourceContainerRegistryName }}.azurecr.io/${{ parameters.dockerRepositoryName }}:${{ parameters.imageTag }} ${{ parameters.destinationContainerRegistryName }}.azurecr.io/${{ parameters.dockerRepositoryName }}:${{ parameters.imageTag }}


- ${{ if eq(parameters.destinationUseAzureServiceConnection, true) }}:
  - task: AzureCLI@2
    displayName: 'Login to destination registry using Azure Service Connection'
    inputs:
      azureSubscription: ${{ parameters.destinationContainerRegistryServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: 'az acr login --name ${{ parameters.destinationContainerRegistryName }}'

- ${{ if eq(parameters.destinationUseAzureServiceConnection, false) }}:
  - task: Docker@2
    displayName: 'Login to destination registry using Docker Service Connection'
    inputs:
      command: 'login'
      containerRegistry: ${{ parameters.destinationContainerRegistryServiceConnection }}

- task: CmdLine@2
  displayName: 'Docker push to destination ACR'
  inputs:
    script: 
      docker push ${{ parameters.destinationContainerRegistryName }}.azurecr.io/${{ parameters.dockerRepositoryName }}:${{ parameters.imageTag }}